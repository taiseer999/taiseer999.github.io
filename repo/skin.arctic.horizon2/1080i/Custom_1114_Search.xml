<?xml version="1.0" encoding="UTF-8"?>
<window type="window" id="1114">
    <defaultcontrol always="true">9099</defaultcontrol>

    <!-- NETWORK OPTIMIZATION 1: Conditional and delayed script loading -->
    <onload condition="!String.IsEmpty(Window(Home).Property(CustomSearchTerm))">
        AlarmClock(search_delay,RunScript(script.skinvariables,set_editcontrol=9099,window_id=1114,setfocus=340,text=$INFO[Window(Home).Property(CustomSearchTerm)]),00:02,silent)</onload>
    <onload
        condition="!String.IsEmpty(Window(Home).Property(CustomSearchTerm)) + !String.IsEqual(Window(Home).Property(ReplaceWindow),1114)">
        ClearProperty(CustomSearchTerm,Home)</onload>

    <!-- NETWORK OPTIMIZATION 2: Set search throttling -->
    <onload>SetProperty(SearchThrottle,500,Home)</onload>
    <onload>SetProperty(LastSearchTime,0,Home)</onload>

    <controls>
        <include>Defs_TMDbHelper_Loader</include>
        <include>Background_ExtraFanart</include>
        <include>Background_Main</include>

        <control type="group">
            <include
                condition="!Window.Previous(Home) + !Skin.HasSetting(Performance.ReduceEffects)">
                Animation_WindowTransition_FadeInOut</include>

            <control type="group">
                <!-- NETWORK OPTIMIZATION 3: Faster window transitions to show search UI quickly -->
                <animation type="WindowOpen" reversible="false"
                    condition="[Window.Previous(Home) | Window.Previous(1120)] + !Skin.HasSetting(Performance.ReduceEffects)">
                    <effect type="fade" start="0" end="100" time="150" delay="0" tween="sine"
                        easing="out" />
                    <effect type="slide" start="-150" end="0" time="200" delay="0" tween="cubic"
                        easing="out" />
                </animation>
                <animation type="WindowClose" reversible="false"
                    condition="[Window.Next(Home) | Window.Next(1120)] + !Skin.HasSetting(Performance.ReduceEffects)">
                    <effect type="fade" start="100" end="0" time="150" delay="0" tween="sine"
                        easing="out" />
                    <effect type="slide" start="0" end="-150" time="150" delay="0" tween="cubic"
                        easing="out" />
                </animation>

                <!-- Performance mode: instant UI -->
                <animation type="WindowOpen" reversible="false"
                    condition="[Window.Previous(Home) | Window.Previous(1120)] + Skin.HasSetting(Performance.ReduceEffects)">
                    <effect type="fade" start="0" end="100" time="0" />
                </animation>
                <animation type="WindowClose" reversible="false"
                    condition="[Window.Next(Home) | Window.Next(1120)] + Skin.HasSetting(Performance.ReduceEffects)">
                    <effect type="fade" start="100" end="0" time="0" />
                </animation>

                <!-- NETWORK OPTIMIZATION 4: Lazy-loaded search results -->
                <control type="grouplist" id="6000">
                    <onup>9099</onup>
                    <ondown>330</ondown>
                    <visible>!$EXP[Exp_InfoDialogs]</visible>
                    <visible>String.IsEmpty(Window(Home).Property(TMDbHelper.HideView))</visible>
                    <include condition="!Skin.HasSetting(Performance.ReduceEffects)">
                        Animation_Common</include>

                    <!-- Reduced bounce animations for faster response -->
                    <animation type="Conditional"
                        condition="Control.IsVisible(340) + !Skin.HasSetting(Performance.ReduceEffects)"
                        reversible="false">
                        <effect type="slide" end="0,5" time="80" tween="sine" />
                        <effect type="slide" end="0,-5" time="120" tween="sine" delay="80" />
                    </animation>
                    <animation type="Conditional"
                        condition="$EXP[Exp_Control330_Visible] + !Skin.HasSetting(Performance.ReduceEffects)"
                        reversible="false">
                        <effect type="slide" end="0,-5" time="80" tween="sine" />
                        <effect type="slide" end="0,5" time="120" tween="sine" delay="80" />
                    </animation>

                    <orientation>vertical</orientation>
                    <control type="group" id="6100">
                        <height>widget_tbump_h</height>
                    </control>
                    <include>skinshortcuts-template-search</include>
                </control>
            </control>

            <!-- NETWORK OPTIMIZATION 5: Conditional wall fade (disabled for search speed) -->
            <include content="Object_WallFade"
                condition="!Skin.HasSetting(Performance.FastMode) + !String.IsEmpty(Container(6000).ListItem.Label)">
                <param name="id" value="6000" />
                <param name="direction_buttons">true</param>
                <visible>!$EXP[Exp_InfoDialogs]</visible>
                <visible>String.IsEmpty(Window(Home).Property(TMDbHelper.HideView))</visible>
            </include>

            <!-- NETWORK OPTIMIZATION 6: Enhanced search bar with throttling -->
            <control type="group">
                <visible>!$EXP[Exp_InfoDialogs]</visible>
                <visible>String.IsEmpty(Window(Home).Property(TMDbHelper.HideView))</visible>
                <left>40</left>
                <top>60</top>
                <height>view_pad</height>

                <control type="group">
                    <left>20</left>
                    <width>740</width>

                    <!-- Search status indicator -->
                    <control type="group">
                        <height>70</height>
                        <centertop>50%</centertop>

                        <!-- Searching state -->
                        <control type="group">
                            <visible>!String.IsEmpty(Window.Property(SearchInProgress))</visible>
                            <include content="Object_MenuBar_Item">
                                <param name="haslabel" value="false" />
                                <param name="selected" value="true" />
                                <param name="visible" value="true" />
                            </include>
                            <control type="image">
                                <left>10</left>
                                <width>60</width>
                                <bordersize>4</bordersize>
                                <aspectratio>keep</aspectratio>
                                <texture colordiffuse="orange">
                                    special://skin/extras/icons/search.png</texture>
                                <animation effect="rotate" start="0" end="360" time="1000"
                                    loop="true" center="auto">Conditional</animation>
                            </control>
                        </control>

                        <!-- Non-focused state -->
                        <control type="group">
                            <visible>!Control.HasFocus(9099) +
                                String.IsEmpty(Window.Property(SearchInProgress))</visible>
                            <include content="Object_MenuBar_Item">
                                <param name="haslabel" value="false" />
                                <param name="color_bg" value="dialog_bg_100" />
                                <param name="visible" value="true" />
                            </include>
                            <control type="image">
                                <left>10</left>
                                <width>60</width>
                                <bordersize>4</bordersize>
                                <aspectratio>keep</aspectratio>
                                <texture colordiffuse="dialog_fg_70">
                                    special://skin/extras/icons/search.png</texture>
                            </control>
                        </control>

                        <!-- Focused state -->
                        <control type="group">
                            <visible>Control.HasFocus(9099) +
                                String.IsEmpty(Window.Property(SearchInProgress))</visible>
                            <include content="Object_MenuBar_Item">
                                <param name="haslabel" value="false" />
                                <param name="selected" value="true" />
                                <param name="visible" value="true" />
                            </include>
                            <control type="image">
                                <left>10</left>
                                <width>60</width>
                                <bordersize>4</bordersize>
                                <aspectratio>keep</aspectratio>
                                <texture colordiffuse="$VAR[ColorSelected]">
                                    special://skin/extras/icons/search.png</texture>
                            </control>
                        </control>
                    </control>

                    <!-- NETWORK OPTIMIZATION 7: Throttled search input -->
                    <include content="Object_Control">
                        <param name="id" value="9099" />
                        <param name="control" value="edit" />
                        <description>Search Input with Network Throttling</description>
                        <texturefocus />
                        <texturenofocus />
                        <font>font_main_bold</font>
                        <textoffsetx>80</textoffsetx>
                        <align>left</align>
                        <onright>Close</onright>
                        <onleft>Close</onleft>

                        <!-- NETWORK OPTIMIZATION 8: Throttled search execution -->
                        <!-- Store search term but don't immediately execute -->
                        <ondown>
                            SetProperty(PreviousSearchTerm,$INFO[Control.GetLabel(9099).index(1)])</ondown>
                        <ondown>SetProperty(PendingSearch,$INFO[Control.GetLabel(9099).index(1)])</ondown>
                        <ondown>SetProperty(LastSearchTime,$INFO[System.Time(hh:mm:ss)])</ondown>
                        <!-- Delayed search execution to allow typing completion -->
                        <ondown>
                            AlarmClock(search_throttle,Skin.SetString(SearchExecute,$INFO[Window.Property(PendingSearch)]),00:01,silent)</ondown>
                        <ondown condition="!Integer.IsEqual(Container(6000).NumItems,0)">6000</ondown>
                        <ondown condition="Integer.IsEqual(Container(6000).NumItems,0)">340</ondown>
                        <onup>340</onup>

                        <!-- NETWORK OPTIMIZATION 9: Immediate local search, delayed network search -->
                        <!-- On text change, immediately show local results, delay network calls -->
                        <onchange>CancelAlarm(network_search,true)</onchange>
                        <onchange>SetProperty(SearchInProgress,1)</onchange>
                        <onchange>
                            AlarmClock(network_search,RunScript(plugin.video.themoviedb.helper,search=$INFO[Control.GetLabel(9099)]),00:02,silent)</onchange>
                    </include>
                </control>
            </control>
        </control>

        <!-- Status and furniture -->
        <control type="group">
            <visible>!$EXP[Exp_InfoDialogs]</visible>
            <visible>!Skin.HasSetting(Performance.FastMode)</visible>
            <include>Furniture_Top_Right</include>
        </control>

        <!-- Search results info -->
        <control type="label">
            <left>80</left>
            <top>140</top>
            <width>600</width>
            <height>30</height>
            <font>font_mini</font>
            <textcolor>main_fg_70</textcolor>
            <label>$INFO[Container(6000).NumItems] results •
                $INFO[Window.Property(SearchInProgress),Searching...,Ready]</label>
            <visible>!String.IsEmpty(Control.GetLabel(9099)) |
                !String.IsEmpty(Window.Property(SearchInProgress))</visible>
        </control>

        <!-- NETWORK OPTIMIZATION 10: Search cache status -->
        <control type="label">
            <left>80</left>
            <bottom>100</bottom>
            <width>600</width>
            <height>30</height>
            <font>font_mini</font>
            <textcolor>main_fg_50</textcolor>
            <label>Network: $INFO[Window.Property(SearchInProgress),Active,Idle] • Last:
                $INFO[Window.Property(LastSearchTime)]</label>
            <visible>Skin.HasSetting(Debug.ShowNetworkInfo)</visible>
        </control>

        <control type="group">
            <include>Furniture_Bottom</include>
            <visible>String.IsEqual(Window.Property(Slide.WidgetInfoStyle),Full)</visible>
            <visible>!String.IsEmpty(Window.Property(Slide.WidgetContainer))</visible>
            <visible>!Skin.HasSetting(Performance.FastMode)</visible>
            <animation effect="fade" start="0" end="100" time="200" delay="100" reversible="false"
                condition="!Skin.HasSetting(Performance.ReduceEffects)">Visible</animation>
        </control>

        <!-- Hidden controls -->
        <control type="button" id="330">
            <width>1</width>
            <height>1</height>
            <left>-1000</left>
            <onfocus>SetFocus(6000)</onfocus>
            <onclick>SetFocus(6000)</onclick>
            <visible allowhiddenfocus="true">Control.HasFocus(330)</visible>
            <animation effect="fade" time="100" start="0" end="0"
                condition="!Skin.HasSetting(Performance.ReduceEffects)">Focus</animation>
        </control>

        <control type="button" id="340">
            <width>1</width>
            <height>1</height>
            <left>-1000</left>
            <onfocus>SetFocus(9099)</onfocus>
            <onclick>SetFocus(9099)</onclick>
            <visible allowhiddenfocus="true">Control.HasFocus(340)</visible>
            <animation effect="fade" time="100" start="0" end="0"
                condition="!Skin.HasSetting(Performance.ReduceEffects)">Focus</animation>
        </control>
    </controls>
</window>